name: Auto Release Minimal

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'

permissions:
  contents: write

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check and create release
      run: |
        # Get latest tag
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.2.0")
        echo "Latest tag: $LATEST_TAG"
        
        # Count commits since tag
        COMMITS=$(git rev-list ${LATEST_TAG}..HEAD --count)
        echo "Commits since tag: $COMMITS"
        
        if [ "$COMMITS" -eq 0 ]; then
          echo "No new commits, skipping release"
          exit 0
        fi
        
        # Calculate new version (simple patch increment)
        VERSION=${LATEST_TAG#v}
        IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
        
        echo "Creating release: $NEW_VERSION"
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create tag
        git tag -a "$NEW_VERSION" -m "Automated release $NEW_VERSION"
        git push origin "$NEW_VERSION"
        
        # Create GitHub release
        gh release create "$NEW_VERSION" \
          --title "Automated release $NEW_VERSION" \
          --notes "Automated release created from commit $(git rev-parse HEAD)" \
          --generate-notes
        
        echo "Released: $NEW_VERSION"
