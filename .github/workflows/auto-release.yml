name: Auto Release Minimal

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'

permissions:
  contents: write

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}
      new-version: ${{ steps.check.outputs.new-version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check and determine version
      id: check
      run: |
        # Get latest tag
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.2.0")
        echo "Latest tag: $LATEST_TAG"

        # Count commits since tag
        COMMITS=$(git rev-list ${LATEST_TAG}..HEAD --count)
        echo "Commits since tag: $COMMITS"

        if [ "$COMMITS" -eq 0 ]; then
          echo "No new commits, skipping release"
          echo "should-release=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Calculate new version (simple patch increment)
        VERSION=${LATEST_TAG#v}
        IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"

        echo "Will create release: $NEW_VERSION"
        echo "should-release=true" >> $GITHUB_OUTPUT
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT

  build:
    needs: check-and-build
    if: needs.check-and-build.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
          - os: windows
            arch: amd64

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'

    - name: Build binary
      env:
        GOOS: ${{ matrix.os }}
        GOARCH: ${{ matrix.arch }}
        CGO_ENABLED: 0
      run: |
        BINARY_NAME="hatcher-${{ matrix.os }}-${{ matrix.arch }}"
        if [ "${{ matrix.os }}" = "windows" ]; then
          BINARY_NAME="${BINARY_NAME}.exe"
        fi

        go build -ldflags "-s -w -X main.Version=${{ needs.check-and-build.outputs.new-version }}" -o "${BINARY_NAME}" ./main.go

        # Create checksum
        if command -v sha256sum >/dev/null 2>&1; then
          sha256sum "${BINARY_NAME}" > "${BINARY_NAME}.sha256"
        else
          shasum -a 256 "${BINARY_NAME}" > "${BINARY_NAME}.sha256"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-${{ matrix.os }}-${{ matrix.arch }}
        path: |
          hatcher-*
          *.sha256

  release:
    needs: [check-and-build, build]
    if: needs.check-and-build.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: binaries-*
        merge-multiple: true

    - name: Create tag and release
      run: |
        NEW_VERSION="${{ needs.check-and-build.outputs.new-version }}"

        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Create tag
        git tag -a "$NEW_VERSION" -m "Automated release $NEW_VERSION"
        git push origin "$NEW_VERSION"

        # Prepare release files
        mkdir -p release
        find . -name "hatcher-*" -type f -exec cp {} release/ \;
        find . -name "*.sha256" -type f -exec cp {} release/ \;
        ls -la release/

        # Create GitHub release with binaries
        gh release create "$NEW_VERSION" \
          --title "Automated release $NEW_VERSION" \
          --notes "Automated release created from commit $(git rev-parse HEAD)" \
          --generate-notes \
          release/*

        echo "Released: $NEW_VERSION"
