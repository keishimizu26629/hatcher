name: Update Version Info

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main

    - name: Update version in files
      run: |
        VERSION="${{ github.event.release.tag_name }}"
        echo "Updating version to: $VERSION"
        
        # Update version in root.go if it exists
        if [ -f "cmd/root.go" ]; then
          sed -i "s/Version: \"[^\"]*\"/Version: \"${VERSION#v}\"/" cmd/root.go
          echo "Updated version in cmd/root.go"
        fi

    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet; then
          echo "has-changes=false" >> $GITHUB_OUTPUT
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit version updates
      if: steps.changes.outputs.has-changes == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add .
        git commit -m "üîñ Update version to ${{ github.event.release.tag_name }}

Automatically updated version information after release.

[skip ci]"
        git push origin main

    - name: Update Homebrew Formula
      if: steps.changes.outputs.has-changes == 'true'
      run: |
        echo "üç∫ Homebrew formula update should be done separately"
        echo "Consider creating a separate workflow or manual update for:"
        echo "- URL update to new release"
        echo "- SHA256 hash update"
        echo "- Version number update"
